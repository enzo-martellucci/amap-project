services:
  # Config Server
  configsvr:
    image: mongo:7.0
    container_name: configsvr
    command: mongod --configsvr --replSet configRS --port 27019 --dbpath /data/db
    ports:
      - "27019:27019"
    volumes:
      - config-data:/data/db
    networks:
      - mongo-network

  # Shard 1 - Mushrooms
  shard1:
    image: mongo:7.0
    container_name: shard1
    command: mongod --shardsvr --replSet shard1RS --port 27018 --dbpath /data/db
    ports:
      - "27018:27018"
    volumes:
      - shard1-data:/data/db
    networks:
      - mongo-network

  # Shard 2 - Bread
  shard2:
    image: mongo:7.0
    container_name: shard2
    command: mongod --shardsvr --replSet shard2RS --port 27017 --dbpath /data/db
    ports:
      - "27017:27017"
    volumes:
      - shard2-data:/data/db
    networks:
      - mongo-network

  # Mongos Router
  mongos:
    image: mongo:7.0
    container_name: mongos
    command: mongos --configdb configRS/configsvr:27019 --port 27020 --bind_ip_all
    ports:
      - "27020:27020"
    depends_on:
      - configsvr
      - shard1
      - shard2
    networks:
      - mongo-network

  # Producer Mushrooms Application
  producer-mushrooms:
    build:
      context: ../producer-mushrooms
      dockerfile: Dockerfile
    container_name: producer-mushrooms
    ports:
      - "8081:8081"
    environment:
      - SPRING_DATA_MONGODB_URI=mongodb://mongos:27020/amap
    depends_on:
      - mongos
    networks:
      - mongo-network

  # Producer Bread Application
  producer-bread:
    build:
      context: ../producer-bread
      dockerfile: Dockerfile
    container_name: producer-bread
    ports:
      - "8082:8082"
    environment:
      - SPRING_DATA_MONGODB_URI=mongodb://mongos:27020/amap
    depends_on:
      - mongos
    networks:
      - mongo-network

  # Marketplace Application
  marketplace:
    build:
      context: ../marketplace
      dockerfile: Dockerfile
    container_name: marketplace
    ports:
      - "8080:8080"
    environment:
      - SPRING_DATA_MONGODB_URI=mongodb://mongos:27020/amap
    depends_on:
      - mongos
    networks:
      - mongo-network

volumes:
  config-data:
  shard1-data:
  shard2-data:

networks:
  mongo-network:
    driver: bridge