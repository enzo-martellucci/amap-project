version: '3.8'

services:
  # Config Server
  configsvr:
    image: mongo:7.0
    container_name: configsvr
    command: mongod --configsvr --replSet configRS --port 27019 --dbpath /data/db
    ports:
      - "27019:27019"
    volumes:
      - config-data:/data/db
    networks:
      - mongo-network

  # Shard 1 - Mushrooms
  shard1:
    image: mongo:7.0
    container_name: shard1
    command: mongod --shardsvr --replSet shard1RS --port 27018 --dbpath /data/db
    ports:
      - "27018:27018"
    volumes:
      - shard1-data:/data/db
    networks:
      - mongo-network

  # Shard 2 - Bread
  shard2:
    image: mongo:7.0
    container_name: shard2
    command: mongod --shardsvr --replSet shard2RS --port 27017 --dbpath /data/db
    ports:
      - "27017:27017"
    volumes:
      - shard2-data:/data/db
    networks:
      - mongo-network

  # Shard 3 - Cheese
  shard3:
    image: mongo:7.0
    container_name: shard3
    command: mongod --shardsvr --replSet shard3RS --port 27016 --dbpath /data/db
    ports:
      - "27016:27016"
    volumes:
      - shard3-data:/data/db
    networks:
      - mongo-network

  # Mongos Router
  mongos:
    image: mongo:7.0
    container_name: mongos
    command: mongos --configdb configRS/configsvr:27019 --port 27020 --bind_ip_all
    ports:
      - "27020:27020"
    depends_on:
      - configsvr
      - shard1
      - shard2
      - shard3
    networks:
      - mongo-network

  # Producer Mushrooms
  producer-mushrooms:
    build:
      context: ../producer
      dockerfile: Dockerfile
    container_name: producer-mushrooms
    ports:
      - "8081:8081"
    environment:
      - SPRING_DATA_MONGODB_URI=mongodb://mongos:27020/amap
      - SERVER_PORT=8081
      - PRODUCER_ID=mushrooms
      - PRODUCER_NAME=Mushroom Producer
    depends_on:
      - mongos
    networks:
      - mongo-network

  # Producer Bread
  producer-bread:
    build:
      context: ../producer
      dockerfile: Dockerfile
    container_name: producer-bread
    ports:
      - "8082:8082"
    environment:
      - SPRING_DATA_MONGODB_URI=mongodb://mongos:27020/amap
      - SERVER_PORT=8082
      - PRODUCER_ID=bread
      - PRODUCER_NAME=Local Bakery
    depends_on:
      - mongos
    networks:
      - mongo-network

  # Producer Cheese
  producer-cheese:
    build:
      context: ../producer
      dockerfile: Dockerfile
    container_name: producer-cheese
    ports:
      - "8083:8083"
    environment:
      - SPRING_DATA_MONGODB_URI=mongodb://mongos:27020/amap
      - SERVER_PORT=8083
      - PRODUCER_ID=cheese
      - PRODUCER_NAME=Cheese Maker
    depends_on:
      - mongos
    networks:
      - mongo-network

  # Marketplace
  marketplace:
    build:
      context: ../marketplace
      dockerfile: Dockerfile
    container_name: marketplace
    ports:
      - "8080:8080"
    environment:
      - SPRING_DATA_MONGODB_URI=mongodb://mongos:27020/amap
    depends_on:
      - mongos
    networks:
      - mongo-network

volumes:
  config-data:
  shard1-data:
  shard2-data:
  shard3-data:

networks:
  mongo-network:
    driver: bridge